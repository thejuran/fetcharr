---
phase: 05-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fetcharr/web/middleware.py
  - fetcharr/__main__.py
  - docker-compose.yml
  - entrypoint.sh
  - fetcharr/static/js/htmx.min.js
  - fetcharr/templates/base.html
  - tests/test_middleware.py
autonomous: true
requirements:
  - SECR-02
  - SECR-05
  - SECR-07

must_haves:
  truths:
    - "Cross-origin POST requests to /settings and /api/search-now/{app} are rejected with 403"
    - "Same-origin POST requests (or requests with no Origin/Referer) succeed normally"
    - "Docker container drops all unnecessary capabilities and sets no-new-privileges"
    - "docker-compose.yml binds port to 127.0.0.1 only"
    - "htmx loads from a local static file, not from an external CDN"
  artifacts:
    - path: "fetcharr/web/middleware.py"
      provides: "Origin/Referer check middleware for CSRF defense"
      contains: "OriginCheckMiddleware"
    - path: "fetcharr/static/js/htmx.min.js"
      provides: "Vendored htmx 2.0.8 JavaScript"
      min_lines: 1
    - path: "tests/test_middleware.py"
      provides: "Tests for Origin check middleware"
      min_lines: 20
  key_links:
    - from: "fetcharr/__main__.py"
      to: "fetcharr/web/middleware.py"
      via: "app.add_middleware(OriginCheckMiddleware)"
      pattern: "add_middleware.*OriginCheckMiddleware"
    - from: "fetcharr/templates/base.html"
      to: "fetcharr/static/js/htmx.min.js"
      via: "local static file reference"
      pattern: "url_for.*static.*js/htmx"
---

<objective>
Harden infrastructure: add CSRF Origin/Referer middleware for all POST endpoints, apply Docker least-privilege defaults, and vendor htmx locally to eliminate CDN dependency.

Purpose: Protect state-changing endpoints from cross-origin attacks, minimize Docker container attack surface, and remove the external unpkg CDN as a single point of failure / supply chain risk.
Output: Origin check middleware, hardened docker-compose.yml + entrypoint.sh, vendored htmx.min.js
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-security-hardening/05-RESEARCH.md
@fetcharr/__main__.py
@fetcharr/templates/base.html
@docker-compose.yml
@entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Origin/Referer CSRF middleware and tests</name>
  <files>
    fetcharr/web/middleware.py
    fetcharr/__main__.py
    tests/test_middleware.py
  </files>
  <action>
Create `fetcharr/web/middleware.py` with an `OriginCheckMiddleware` class inheriting from `starlette.middleware.base.BaseHTTPMiddleware`:

- On POST requests only, extract `Origin` header. If present, parse with `urllib.parse.urlparse` and compare `.netloc` against the `Host` header. If mismatch, return `starlette.responses.Response("Forbidden", status_code=403)`.
- If `Origin` is absent, check `Referer` header with same logic.
- If neither `Origin` nor `Referer` is present, ALLOW the request (same-origin browser behavior -- see Research Pattern 1 and Pitfall 3).
- Non-POST methods always pass through.

Register middleware in `fetcharr/__main__.py` in the `_run()` function, AFTER creating the FastAPI app and BEFORE `app.include_router(router)`:
```python
from fetcharr.web.middleware import OriginCheckMiddleware
app.add_middleware(OriginCheckMiddleware)
```

Create `tests/test_middleware.py` with tests:
1. POST with matching Origin header -> 200 (passes through)
2. POST with mismatched Origin header -> 403
3. POST with matching Referer (no Origin) -> 200
4. POST with mismatched Referer (no Origin) -> 403
5. POST with no Origin and no Referer -> 200 (allowed)
6. GET request with mismatched Origin -> 200 (non-POST passes through)

Use FastAPI TestClient with a minimal test app that has the middleware and a simple POST endpoint. Follow existing test patterns (see tests/test_web.py for project conventions).
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && python -m pytest tests/test_middleware.py -x -v</automated>
  </verify>
  <done>OriginCheckMiddleware registered on the app; cross-origin POSTs return 403, same-origin and no-header POSTs pass through, GET always passes through. Six tests passing.</done>
</task>

<task type="auto">
  <name>Task 2: Docker hardening and htmx vendoring</name>
  <files>
    docker-compose.yml
    entrypoint.sh
    fetcharr/static/js/htmx.min.js
    fetcharr/templates/base.html
  </files>
  <action>
**Docker hardening (SECR-05):**

Update `docker-compose.yml`:
- Change port binding from `"8080:8080"` to `"127.0.0.1:8080:8080"` (localhost only)
- Add `cap_drop: [ALL]` to drop all Linux capabilities
- Add `cap_add: [CHOWN, SETUID, SETGID]` to keep only the capabilities needed for the entrypoint's groupadd/useradd/chown/setpriv (see Research Pitfall 2 for why these three are needed)
- Add `security_opt: [no-new-privileges:true]` to prevent privilege escalation

Update `entrypoint.sh`:
- Add `--no-new-privileges` flag to the `exec setpriv` command (flag only, no `=true` -- see Research Pitfall 5)
- Final line becomes: `exec setpriv --reuid="$PUID" --regid="$PGID" --init-groups --no-new-privileges python -m fetcharr`

**htmx vendoring (SECR-07):**

Download htmx 2.0.8 minified JS:
- Run: `curl -sL https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js -o fetcharr/static/js/htmx.min.js`
- Create the `fetcharr/static/js/` directory first if it doesn't exist

Update `fetcharr/templates/base.html`:
- Replace `<script src="https://unpkg.com/htmx.org@2.0.8"></script>` with `<script src="{{ url_for('static', path='js/htmx.min.js') }}"></script>`
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && grep -q "127.0.0.1:8080:8080" docker-compose.yml && grep -q "cap_drop" docker-compose.yml && grep -q "no-new-privileges" docker-compose.yml && grep -q "no-new-privileges" entrypoint.sh && test -f fetcharr/static/js/htmx.min.js && grep -q "url_for" fetcharr/templates/base.html && ! grep -q "unpkg" fetcharr/templates/base.html && echo "ALL CHECKS PASSED"</automated>
  </verify>
  <done>docker-compose.yml binds to localhost, drops all caps (re-adds CHOWN/SETUID/SETGID), sets no-new-privileges. entrypoint.sh passes --no-new-privileges to setpriv. htmx.min.js vendored locally, CDN script tag removed from base.html.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_middleware.py -x -v` -- all middleware tests pass
2. `grep -c "unpkg" fetcharr/templates/base.html` returns 0 (no CDN references)
3. `grep "127.0.0.1" docker-compose.yml` shows localhost-only binding
4. `grep "no-new-privileges" entrypoint.sh` shows the setpriv flag
5. `stat -f "%Lp" fetcharr/static/js/htmx.min.js` confirms file exists (non-empty)
</verification>

<success_criteria>
- Origin/Referer middleware active on all POST endpoints with 6 tests passing
- docker-compose.yml: localhost port binding, cap_drop ALL, cap_add CHOWN/SETUID/SETGID, no-new-privileges
- entrypoint.sh: --no-new-privileges on setpriv exec
- htmx served from local static file, no external CDN reference in any template
</success_criteria>

<output>
After completion, create `.planning/phases/05-security-hardening/05-01-SUMMARY.md`
</output>
