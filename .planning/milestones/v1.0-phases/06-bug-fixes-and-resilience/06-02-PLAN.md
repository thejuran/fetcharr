---
phase: 06-bug-fixes-and-resilience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - fetcharr/clients/base.py
  - fetcharr/search/engine.py
autonomous: true
requirements:
  - QUAL-06

must_haves:
  truths:
    - "RemoteProtocolError during API requests triggers a retry instead of crashing"
    - "Malformed API response (ValidationError) in validate_connection returns False with a warning, not an unhandled exception"
    - "deduplicate_to_seasons skips episode records missing seriesId or seasonNumber instead of crashing with KeyError"
    - "Cycle abort catch in engine.py covers all httpx error types without redundant catches"
  artifacts:
    - path: "fetcharr/clients/base.py"
      provides: "Broadened retry catch (TransportError), ValidationError catch in validate_connection"
      contains: "TransportError"
    - path: "fetcharr/search/engine.py"
      provides: "Safe .get() in deduplicate_to_seasons, simplified cycle abort catch"
      contains: "ep.get"
  key_links:
    - from: "fetcharr/clients/base.py"
      to: "httpx.TransportError"
      via: "retry except clause"
      pattern: "httpx\\.TransportError"
    - from: "fetcharr/clients/base.py"
      to: "pydantic.ValidationError"
      via: "validate_connection except clause"
      pattern: "ValidationError"
    - from: "fetcharr/search/engine.py"
      to: "deduplicate_to_seasons"
      via: ".get() with None check"
      pattern: "ep\\.get"
---

<objective>
Fix httpx exception hierarchy gaps and API response parsing resilience in clients and search engine.

Purpose: Ensure all transient transport failures (including RemoteProtocolError) trigger retries, malformed API responses are caught gracefully instead of crashing, and missing episode fields don't cause KeyErrors. This is the QUAL-06 fix covering three related error handling bugs.

Output: Updated `fetcharr/clients/base.py` and `fetcharr/search/engine.py` with correct exception handling.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bug-fixes-and-resilience/06-RESEARCH.md
@fetcharr/clients/base.py
@fetcharr/search/engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Broaden retry catch to TransportError and add ValidationError handling in base client</name>
  <files>fetcharr/clients/base.py</files>
  <action>
Two changes to `fetcharr/clients/base.py`:

**1. Broaden retry exception catch in `_request_with_retry` (Bug 6a):**
Replace `(httpx.HTTPStatusError, httpx.ConnectError, httpx.TimeoutException)` with `(httpx.HTTPStatusError, httpx.TransportError)` in BOTH the first try/except AND the inner retry try/except. `httpx.TransportError` is the parent class of `TimeoutException`, `NetworkError` (incl. `ConnectError`), and `ProtocolError` (incl. `RemoteProtocolError`). This covers all transient transport failures with a single catch while keeping `HTTPStatusError` separate (it's NOT a `TransportError` subclass).

The first except block (line ~49):
```python
except (httpx.HTTPStatusError, httpx.TransportError):
```

The retry except block (line ~60-64):
```python
except (httpx.HTTPStatusError, httpx.TransportError) as exc:
```

**2. Add `ValidationError` catch in `validate_connection` (Bug 6b):**
Add `import pydantic` at the top of the file. After the existing `except httpx.TimeoutException` block in `validate_connection`, add a new except clause:
```python
except pydantic.ValidationError as exc:
    logger.warning(
        "{app}: Unexpected API response format: {exc}",
        app=self._app_name,
        exc=exc,
    )
    return False
```

This catches the case where the *arr API returns unexpected JSON that doesn't match the `SystemStatus` model.

Do NOT change the `get_paginated` method's exception handling -- `ValidationError` there should propagate to the cycle abort handler (the caller handles it). Do NOT change function signatures.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && python -m pytest tests/test_clients.py -x -q</automated>
    <manual>Verify existing client tests still pass</manual>
  </verify>
  <done>_request_with_retry catches httpx.TransportError (covers RemoteProtocolError). validate_connection catches pydantic.ValidationError. All existing client tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix deduplicate_to_seasons missing fields and simplify cycle abort catches</name>
  <files>fetcharr/search/engine.py</files>
  <action>
Two changes to `fetcharr/search/engine.py`:

**1. Fix `deduplicate_to_seasons` (Bug 6c):**
Replace the direct bracket access `ep["seriesId"]` and `ep["seasonNumber"]` with `.get()` and skip-on-missing:
```python
for ep in episodes:
    series_id = ep.get("seriesId")
    season_number = ep.get("seasonNumber")
    if series_id is None or season_number is None:
        continue
    key = (series_id, season_number)
    if key not in seen:
        seen.add(key)
        title = ep.get("series", {}).get("title", f"Series {series_id}")
        seasons.append(
            {
                "seriesId": series_id,
                "seasonNumber": season_number,
                "display_name": f"{title} - Season {season_number}",
            }
        )
```

This skips malformed episode records instead of crashing with KeyError. Note: the fallback title also changes from `f"Series {ep['seriesId']}"` to `f"Series {series_id}"` since we already extracted it.

**2. Simplify cycle abort catches in `run_radarr_cycle` and `run_sonarr_cycle`:**
Both cycle functions currently catch `(httpx.HTTPStatusError, httpx.ConnectError, httpx.TimeoutException, httpx.HTTPError)`. This is redundant because `httpx.HTTPError` is the parent of all the others. Simplify both to just `httpx.HTTPError`:

In `run_radarr_cycle` (line ~172):
```python
except httpx.HTTPError as exc:
```

In `run_sonarr_cycle` (line ~255):
```python
except httpx.HTTPError as exc:
```

This is cleaner and also covers `ValidationError` propagating from `get_paginated` (via `PaginatedResponse.model_validate`) since it will be caught as a different exception type. Actually -- `ValidationError` is NOT an `httpx.HTTPError` subclass, so add `pydantic.ValidationError` to the catch as well:
```python
except (httpx.HTTPError, pydantic.ValidationError) as exc:
```

Add `import pydantic` at the top of the file alongside the existing imports.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && python -m pytest tests/test_search.py -x -q</automated>
    <manual>Verify existing search tests still pass, especially deduplicate_to_seasons tests</manual>
  </verify>
  <done>deduplicate_to_seasons uses .get() with skip-on-missing. Cycle abort catches simplified to httpx.HTTPError + pydantic.ValidationError. All existing search tests pass.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/julianamacbook/fetcharr && python -m pytest tests/test_clients.py tests/test_search.py -x -v
```
All client and search tests pass. No regression.
</verification>

<success_criteria>
- `_request_with_retry` catches `httpx.TransportError` (covers RemoteProtocolError, ReadError, etc.)
- `validate_connection` catches `pydantic.ValidationError` and returns False
- `deduplicate_to_seasons` skips episodes missing `seriesId` or `seasonNumber`
- Cycle abort catches use `httpx.HTTPError` (no redundant subcatches) plus `pydantic.ValidationError`
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes-and-resilience/06-02-SUMMARY.md`
</output>
