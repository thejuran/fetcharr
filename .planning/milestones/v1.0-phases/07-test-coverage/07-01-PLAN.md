---
phase: 07-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/conftest.py
  - tests/test_clients.py
autonomous: true
requirements:
  - QUAL-07

must_haves:
  truths:
    - "_request_with_retry returns response on first-attempt success without retry"
    - "_request_with_retry retries once on first failure, returns success response on second attempt"
    - "_request_with_retry re-raises exception when retry also fails"
    - "get_paginated returns all records across multiple pages"
    - "get_paginated returns empty list for zero totalRecords"
    - "get_paginated returns records from a single page"
    - "get_paginated raises ValidationError on malformed API response"
    - "validate_connection returns True on 200 with valid system status"
    - "validate_connection returns False on 401 Unauthorized"
    - "validate_connection returns False on ConnectError"
    - "validate_connection returns False on TimeoutException"
  artifacts:
    - path: "tests/conftest.py"
      provides: "Shared test fixtures (settings factory, default state factory)"
      min_lines: 15
    - path: "tests/test_clients.py"
      provides: "ArrClient base method async tests (11 new tests added to existing file)"
      contains: "MockTransport"
  key_links:
    - from: "tests/test_clients.py"
      to: "fetcharr/clients/base.py"
      via: "httpx.MockTransport injected into ArrClient._client"
      pattern: "MockTransport"
---

<objective>
Add async test coverage for all ArrClient base methods: `_request_with_retry` (3 tests), `get_paginated` (4 tests), and `validate_connection` (4 tests), using httpx MockTransport for transport-layer mocking.

Purpose: These 11 tests cover the three core async methods in the HTTP client base class -- retry logic, pagination, and connection validation -- which are the foundation all higher-level search operations depend on. This addresses success criteria 1-3 of QUAL-07.

Output: Updated `tests/test_clients.py` with 11 new async tests, new `tests/conftest.py` with shared fixtures.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-test-coverage/07-RESEARCH.md

@fetcharr/clients/base.py
@fetcharr/models/arr.py
@fetcharr/models/config.py
@tests/test_clients.py
@tests/test_startup.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conftest.py with shared test fixtures</name>
  <files>tests/conftest.py</files>
  <action>
Create `tests/conftest.py` with shared fixtures used across multiple test files:

1. **`make_settings` helper function** (not a fixture -- a plain factory function):
   - Accepts keyword args: `radarr_url`, `radarr_enabled`, `radarr_api_key`, `sonarr_url`, `sonarr_enabled`, `sonarr_api_key`, plus `search_missing_count`, `search_cutoff_count`, `search_interval` with sensible defaults.
   - Returns a `Settings` instance with `ArrConfig` objects.
   - Default: radarr enabled at `http://radarr:7878` with key `"radarr-test-key"`, sonarr enabled at `http://sonarr:8989` with key `"sonarr-test-key"`.
   - This mirrors the `_make_settings` pattern already in `test_startup.py` but is reusable.

2. **`default_state` helper function** (plain factory, not a fixture):
   - Simply re-exports `_default_state()` from `fetcharr.state` for convenience.
   - This avoids every test file having to import from `fetcharr.state` directly.

Keep the file simple -- no autouse fixtures, no MockTransport fixtures (those are test-local since each test needs a different handler). Import `Settings`, `ArrConfig` from `fetcharr.models.config` and `_default_state` from `fetcharr.state`.
  </action>
  <verify>
    <automated>python3 -c "import ast; ast.parse(open('tests/conftest.py').read()); print('OK')"</automated>
    <manual>conftest.py has make_settings and default_state helpers</manual>
  </verify>
  <done>conftest.py exists with make_settings and default_state factory functions importable by all test files</done>
</task>

<task type="auto">
  <name>Task 2: Add async ArrClient base method tests to test_clients.py</name>
  <files>tests/test_clients.py</files>
  <action>
Append 11 new async test functions to the existing `tests/test_clients.py`. All tests use `httpx.MockTransport` to inject controlled responses into `ArrClient._client`. Add necessary imports at the top: `import asyncio`, `from unittest.mock import AsyncMock, patch`, `import httpx`, `import pydantic`.

**_request_with_retry tests (3 tests):**

1. `test_request_with_retry_first_attempt_success` -- MockTransport returns 200. Assert response.status_code == 200. No retry occurs.

2. `test_request_with_retry_retries_on_failure` -- Closure-based handler: first call returns 500, second call returns 200. Patch `asyncio.sleep` as `AsyncMock` to avoid 2s wait. Assert `call_count == 2` on the handler and `response.status_code == 200`.

3. `test_request_with_retry_reraises_when_retry_fails` -- Handler always returns 500. Patch `asyncio.sleep` as `AsyncMock`. Use `pytest.raises(httpx.HTTPStatusError)`. Assert the exception is raised (not swallowed).

**get_paginated tests (4 tests):**

4. `test_get_paginated_single_page` -- Handler returns `{"page": 1, "pageSize": 50, "sortKey": "id", "totalRecords": 2, "records": [{"id": 1}, {"id": 2}]}`. Assert result has 2 items.

5. `test_get_paginated_multi_page` -- Handler returns page 1 with totalRecords=3 and 2 records, page 2 with 1 record. Assert result has 3 items. Use `request.url.params.get("page", "1")` to determine which page.

6. `test_get_paginated_empty_results` -- Handler returns `{"page": 1, "pageSize": 50, "sortKey": "id", "totalRecords": 0, "records": []}`. Assert result is `[]`.

7. `test_get_paginated_malformed_response` -- Handler returns `{"bad": "data"}`. Use `pytest.raises(pydantic.ValidationError)`.

**validate_connection tests (4 tests):**

8. `test_validate_connection_success` -- Handler returns 200 with `{"version": "5.0.0"}`. Assert returns `True`.

9. `test_validate_connection_401` -- Handler returns 401. Assert returns `False`.

10. `test_validate_connection_connect_error` -- Handler raises `httpx.ConnectError("refused")`. Assert returns `False`.

11. `test_validate_connection_timeout` -- Handler raises `httpx.TimeoutException("timed out")`. Assert returns `False`.

**For all tests:**
- Create `ArrClient(base_url="http://test", api_key="key")` and set `client._app_name = "Test"`.
- Replace `client._client` with `httpx.AsyncClient(transport=transport)`.
- Use `try/finally` with `await client.close()` to avoid resource warnings.
- Do NOT use `@pytest.mark.asyncio` (asyncio_mode=auto handles it).

**Important:** For validate_connection tests, note that `validate_connection` calls `self._client.get()` directly (not `_request_with_retry`). The MockTransport response object gets the request attached automatically when routed through the client, so `raise_for_status()` works correctly.
  </action>
  <verify>
    <automated>python3 -c "import ast; tree = ast.parse(open('tests/test_clients.py').read()); funcs = [n.name for n in ast.walk(tree) if isinstance(n, (ast.FunctionDef, ast.AsyncFunctionDef))]; print(f'{len(funcs)} functions'); assert len(funcs) >= 19, f'Expected >= 19 functions, got {len(funcs)}'"</automated>
    <manual>Verify 8 existing sync tests + 11 new async tests = 19+ test functions total</manual>
  </verify>
  <done>test_clients.py has 11 new async tests covering _request_with_retry (3), get_paginated (4), and validate_connection (4) using MockTransport</done>
</task>

</tasks>

<verification>
- `tests/conftest.py` exists with `make_settings` and `default_state` helpers
- `tests/test_clients.py` contains all 11 new async test functions plus original 8
- All new tests use `httpx.MockTransport` for transport-layer mocking
- Retry tests patch `asyncio.sleep` to avoid 2-second waits
- No new dependencies added (all tools are stdlib or already installed)
- Tests follow `asyncio_mode = "auto"` convention (no `@pytest.mark.asyncio` decorators)
</verification>

<success_criteria>
- 11 new async tests added to test_clients.py covering all three base client methods
- conftest.py created with shared factory functions
- AST parse succeeds for both files (valid Python syntax)
- Success criteria 1-3 of QUAL-07 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-coverage/07-01-SUMMARY.md`
</output>
