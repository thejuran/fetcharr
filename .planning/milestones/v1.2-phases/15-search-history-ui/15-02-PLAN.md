---
phase: 15-search-history-ui
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified:
  - tests/test_db.py
  - tests/test_web.py
autonomous: true
requirements: [SRCH-14]

must_haves:
  truths:
    - "get_search_history returns correct entries for each filter combination"
    - "get_search_history pagination returns correct page slices and total count"
    - "GET /history returns 200 and contains Search History heading"
    - "GET /partials/history-results returns 200 with filter and pagination markup"
    - "Filter query params are passed through to database query"
  artifacts:
    - path: "tests/test_db.py"
      provides: "Tests for get_search_history filtering and pagination"
      contains: "test_get_search_history"
    - path: "tests/test_web.py"
      provides: "Tests for /history and /partials/history-results routes"
      contains: "test_history_page"
  key_links:
    - from: "tests/test_db.py"
      to: "fetcharr/db.py"
      via: "imports and calls get_search_history"
      pattern: "from fetcharr.db import.*get_search_history"
    - from: "tests/test_web.py"
      to: "fetcharr/web/routes.py"
      via: "TestClient HTTP requests to /history and /partials/history-results"
      pattern: "client.get.*history"
---

<objective>
Add comprehensive tests for the search history backend query and web routes to validate filtering, pagination, and template rendering.

Purpose: Ensure the search history feature works correctly across all filter combinations and edge cases before shipping.

Output: Test functions in test_db.py and test_web.py covering SRCH-14 functionality.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-search-history-ui/15-CONTEXT.md
@.planning/phases/15-search-history-ui/15-01-SUMMARY.md

@fetcharr/db.py
@fetcharr/web/routes.py
@tests/test_db.py
@tests/test_web.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database query tests for get_search_history</name>
  <files>tests/test_db.py</files>
  <action>
Add a new section at the bottom of `tests/test_db.py` with a comment header:

```python
# ---------------------------------------------------------------------------
# Search history filtering and pagination tests (SRCH-14)
# ---------------------------------------------------------------------------
```

Add import for `get_search_history` in the existing import line from `fetcharr.db`.

**Test functions to add:**

1. `test_get_search_history_default_returns_all(tmp_path)`:
   - Init DB, insert 3 entries (mix of Radarr/Sonarr, missing/cutoff).
   - Call `get_search_history(db_path)` with no filters.
   - Assert result["total"] == 3, result["page"] == 1, result["per_page"] == 50, result["total_pages"] == 1.
   - Assert len(result["entries"]) == 3.
   - Assert entries are newest-first (by id DESC).

2. `test_get_search_history_filter_by_app(tmp_path)`:
   - Insert 2 Radarr and 1 Sonarr entries.
   - Call with `app_filter=["Radarr"]`.
   - Assert result["total"] == 2, all entries have app == "Radarr".

3. `test_get_search_history_filter_by_queue_type(tmp_path)`:
   - Insert entries with different queue types.
   - Call with `queue_filter=["cutoff"]`.
   - Assert only cutoff entries returned.

4. `test_get_search_history_filter_by_outcome(tmp_path)`:
   - Insert entries with outcome="searched" and outcome="failed".
   - Call with `outcome_filter=["failed"]`.
   - Assert only failed entries returned.

5. `test_get_search_history_text_search(tmp_path)`:
   - Insert "The Matrix", "Matrix Reloaded", "Inception".
   - Call with `search_text="matrix"` (lowercase to test case-insensitivity).
   - Assert result["total"] == 2.

6. `test_get_search_history_combined_filters(tmp_path)`:
   - Insert diverse entries (mix of apps, queue types, outcomes).
   - Call with `app_filter=["Radarr"]`, `queue_filter=["missing"]`.
   - Assert only entries matching BOTH filters returned.

7. `test_get_search_history_pagination(tmp_path)`:
   - Insert 75 entries (loop with `f"Movie {i}"`).
   - Call with default per_page=50, page=1. Assert len(entries) == 50, total == 75, total_pages == 2.
   - Call with page=2. Assert len(entries) == 25.

8. `test_get_search_history_empty_db(tmp_path)`:
   - Init DB, no inserts.
   - Call `get_search_history(db_path)`.
   - Assert result["total"] == 0, result["entries"] == [], result["total_pages"] == 1.

9. `test_get_search_history_entries_have_id(tmp_path)`:
   - Insert 1 entry. Call `get_search_history(db_path)`.
   - Assert "id" key exists in each entry dict.

All tests are async (pytest-asyncio auto mode). Follow existing patterns: `tmp_path` fixture, `await init_db(db_path)`, `await insert_search_entry(...)`.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_db.py -x -q</automated>
  </verify>
  <done>
    - 9 new test functions in test_db.py covering all filter types, combined filters, pagination, empty DB, and entry shape
    - All tests pass including both new and existing tests
  </done>
</task>

<task type="auto">
  <name>Task 2: Web route tests for history page and partial</name>
  <files>tests/test_web.py</files>
  <action>
Add a new section at the bottom of `tests/test_web.py` with a comment header:

```python
# ---------------------------------------------------------------------------
# SRCH-14: Search history page and partial tests
# ---------------------------------------------------------------------------
```

**Test functions to add** (use existing `client` and `test_app` fixtures):

1. `test_history_page_returns_200(client)`:
   - `client.get("/history")` returns 200.
   - Response contains "Search History" heading.

2. `test_history_page_has_nav_link(client)`:
   - `client.get("/history")` response contains `href="/history"` in nav.
   - The History nav link has the active class (`text-white`).

3. `test_history_page_shows_entries(client)`:
   - The test_app fixture already inserts "Test Movie". Verify it appears in the response.

4. `test_history_results_partial_returns_200(client)`:
   - `client.get("/partials/history-results")` returns 200.
   - Response contains `id="history-results"` (the htmx swap target).

5. `test_history_results_partial_with_app_filter(client)`:
   - `client.get("/partials/history-results?app=Radarr")` returns 200.
   - Response contains "Radarr" (the entry from fixture).

6. `test_history_results_partial_pagination(client, test_app)`:
   - Insert 60 additional entries via a loop using `insert_search_entry` (use `await` pattern — make this an async test with TestClient created manually).
   - Request page 2: `client.get("/partials/history-results?page=2")`.
   - Assert response contains pagination markup.

7. `test_history_page_empty_state(test_app, tmp_path)`:
   - Create a fresh empty DB at a different tmp_path, set it on test_app.
   - Use TestClient to GET /history.
   - Assert response contains "No search history yet".

8. `test_dashboard_nav_has_history_link(client)`:
   - `client.get("/")` response contains `href="/history"`.
   - Verify the nav bar on dashboard includes the History link.

For async tests that need to insert data, follow the existing pattern in test_web.py (e.g., `test_search_log_shows_outcome_badge` which is async with manual TestClient creation).
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_web.py -x -q</automated>
  </verify>
  <done>
    - 8 new test functions in test_web.py covering history page rendering, nav link, partials, filters, pagination, empty state
    - All tests pass including both new and existing tests
    - Full test suite passes: `uv run pytest tests/ -x -q`
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_db.py -x -q` — all DB tests pass (existing + 9 new)
2. `uv run pytest tests/test_web.py -x -q` — all web tests pass (existing + 8 new)
3. `uv run pytest tests/ -x -q` — full test suite passes
4. `uv run ruff check tests/test_db.py tests/test_web.py` — no lint errors
</verification>

<success_criteria>
- 9 new tests in test_db.py validate get_search_history filtering, pagination, and edge cases
- 8 new tests in test_web.py validate /history page, /partials/history-results, nav link, and empty state
- Full test suite passes with zero failures
- No ruff lint violations in test files
</success_criteria>

<output>
After completion, create `.planning/phases/15-search-history-ui/15-02-SUMMARY.md`
</output>
