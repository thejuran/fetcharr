---
phase: 16-deep-code-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fetcharr/templates/partials/history_results.html
  - fetcharr/db.py
  - fetcharr/web/validation.py
  - tests/test_web.py
  - tests/test_validation.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "hx-vals attribute in history_results.html uses double-quote delimiters with tojson filter, preventing single-quote XSS breakout"
    - "All aiosqlite cursors in db.py are managed via async with for deterministic cleanup"
    - "get_search_history guards against per_page < 1 and page < 1 to prevent ZeroDivisionError"
    - "SSRF blocklist includes IPv6 loopback, 0.0.0.0, Azure metadata, and Alibaba metadata addresses"
    - "Regression tests exist for W1 (XSS hx-vals) and W7 (SSRF blocklist gaps)"
  artifacts:
    - path: "fetcharr/templates/partials/history_results.html"
      provides: "XSS-safe hx-vals attribute using tojson filter"
      contains: "tojson"
    - path: "fetcharr/db.py"
      provides: "Cursor cleanup via async with, per_page/page guard"
      contains: "async with db.execute"
    - path: "fetcharr/web/validation.py"
      provides: "Expanded SSRF blocklist with loopback check"
      contains: "is_loopback"
    - path: "tests/test_web.py"
      provides: "XSS regression test for hx-vals attribute"
      contains: "test_history_results_hx_vals_no_single_quote_breakout"
    - path: "tests/test_validation.py"
      provides: "SSRF blocklist regression tests"
      contains: "test_ipv6_loopback_blocked"
  key_links:
    - from: "fetcharr/templates/partials/history_results.html"
      to: "Jinja2 tojson filter"
      via: "double-quoted hx-vals attribute"
      pattern: 'hx-vals="{{ .* \| tojson }}"'
    - from: "fetcharr/web/validation.py"
      to: "fetcharr/web/routes.py"
      via: "validate_arr_url import"
      pattern: "is_loopback"
---

<objective>
Fix 4 warning-level code review issues: W1 (XSS in hx-vals), W4 (unclosed aiosqlite cursors), W5 (ZeroDivisionError on per_page=0), W7 (SSRF blocklist gaps). Add regression tests for the two security fixes (W1, W7).

Purpose: Close security vulnerabilities and resource leak risks found in the Phase 16 deep code review.
Output: Patched source files and new regression tests.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-deep-code-review/16-REVIEW.md
@.planning/phases/16-deep-code-review/16-CONTEXT.md
@fetcharr/templates/partials/history_results.html
@fetcharr/db.py
@fetcharr/web/validation.py
@tests/test_web.py
@tests/test_validation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix W1 (XSS), W4 (cursors), W5 (zero division), W7 (SSRF blocklist)</name>
  <files>
    fetcharr/templates/partials/history_results.html
    fetcharr/db.py
    fetcharr/web/validation.py
  </files>
  <action>
**W1 -- XSS in hx-vals (history_results.html:89):**
Replace the single-quoted `hx-vals` attribute on the text search input with a double-quoted attribute using Jinja2's `tojson` filter. Change:
```
hx-vals='{"app": "{{ active_apps | join(',') }}", "queue": "{{ active_queues | join(',') }}", "outcome": "{{ active_outcomes | join(',') }}", "page": "1"}'
```
to:
```
hx-vals="{{ {'app': active_apps | join(','), 'queue': active_queues | join(','), 'outcome': active_outcomes | join(','), 'page': '1'} | tojson }}"
```
This ensures single-quote characters in user input cannot break out of the attribute context, since `tojson` produces JSON with double-quote escaping and the outer attribute uses double quotes.

Audit all other templates for single-quoted `hx-vals` patterns -- grep confirms only this one instance exists.

**W4 -- Unclosed aiosqlite cursors (db.py:118, 189, 198):**
Wrap all three `cursor = await db.execute(...)` / `rows = await cursor.fetchall()` patterns with `async with db.execute(...) as cursor:` blocks. There are 3 locations in db.py:
1. `get_recent_searches` (line ~118): the single query
2. `get_search_history` COUNT query (line ~189)
3. `get_search_history` data query (line ~198)

**W5 -- ZeroDivisionError if per_page=0 (db.py:223):**
At the top of `get_search_history`, add guards:
```python
if per_page < 1:
    per_page = 50
if page < 1:
    page = 1
```
Place these before any use of `per_page` or `page` in calculations.

**W7 -- SSRF blocklist gaps (validation.py:13):**
1. Add `"metadata.azure.com"` and `"100.100.100.200"` (Alibaba cloud metadata) to BLOCKED_HOSTS
2. In the `try` block that checks `ipaddress.ip_address(hostname)`, change the condition from `addr.is_link_local` to `addr.is_link_local or addr.is_loopback`. This blocks `::1`, `127.0.0.1`, and `0.0.0.0`.
3. Update the error message to say "Blocked address" (covers both link-local and loopback).
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_validation.py tests/test_db.py tests/test_web.py -x -q</automated>
    <manual>Verify hx-vals uses double quotes in template, cursors use async with, validation.py has expanded blocklist</manual>
  </verify>
  <done>
    - hx-vals attribute uses double-quoted tojson pattern (no single-quote breakout possible)
    - All 3 aiosqlite cursors use async with for deterministic cleanup
    - get_search_history guards per_page < 1 and page < 1
    - BLOCKED_HOSTS includes Azure and Alibaba metadata, loopback addresses blocked via is_loopback
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for W1 (XSS) and W7 (SSRF blocklist)</name>
  <files>
    tests/test_web.py
    tests/test_validation.py
  </files>
  <action>
**W1 regression test (test_web.py):**
Add a test to `test_web.py` that verifies the hx-vals attribute in the history results partial cannot be broken by single-quote injection. The test should:
1. GET `/partials/history-results?search=foo'+onmouseover='alert(1)` (the XSS payload in the search param)
2. Assert the response does NOT contain `onmouseover=` outside of a properly-escaped JSON string
3. Assert the response contains `hx-vals="` (double-quote delimiter, not single-quote)
4. Assert the response does NOT contain `hx-vals='` (single-quote delimiter)

Name: `test_history_results_hx_vals_no_single_quote_breakout`

**W7 regression tests (test_validation.py):**
Add to the `TestValidateArrUrl` class:
1. `test_ipv6_loopback_blocked`: `validate_arr_url("http://[::1]:7878")` should return `(False, ...)` with "blocked" in error
2. `test_ipv4_loopback_blocked`: `validate_arr_url("http://127.0.0.1:7878")` should return `(False, ...)` with "blocked" in error
3. `test_zero_address_blocked`: `validate_arr_url("http://0.0.0.0:7878")` should return `(False, ...)`
4. `test_azure_metadata_blocked`: `validate_arr_url("http://metadata.azure.com")` should return `(False, ...)`
5. `test_alibaba_metadata_blocked`: `validate_arr_url("http://100.100.100.200")` should return `(False, ...)`

**W5 regression test (test_db.py):**
Add a test that calls `get_search_history(db_path, per_page=0)` and verifies it returns a valid result (no ZeroDivisionError). Name: `test_get_search_history_zero_per_page_defaults`.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_validation.py tests/test_web.py tests/test_db.py -x -q</automated>
  </verify>
  <done>
    - W1 regression test confirms hx-vals uses double quotes and XSS payload is escaped
    - W7 regression tests confirm loopback (IPv4, IPv6, 0.0.0.0), Azure metadata, and Alibaba metadata are all blocked
    - W5 regression test confirms per_page=0 does not cause ZeroDivisionError
    - All existing tests continue to pass
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/julianamacbook/fetcharr && uv run pytest tests/ -x -q
cd /Users/julianamacbook/fetcharr && uv run ruff check fetcharr/ tests/
```
All tests pass. No ruff violations introduced.
</verification>

<success_criteria>
- W1: hx-vals in history_results.html uses `{{ ... | tojson }}"` pattern with double-quote delimiters
- W4: All 3 cursor sites in db.py use `async with db.execute(...)`
- W5: get_search_history has per_page/page guards at function top
- W7: BLOCKED_HOSTS includes Azure + Alibaba, is_loopback check added
- 7 new regression tests pass (1 for W1, 5 for W7, 1 for W5)
- Existing test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/16-deep-code-review/16-01-SUMMARY.md`
</output>
