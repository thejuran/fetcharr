---
phase: 16-deep-code-review
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - fetcharr/web/routes.py
  - .planning/phases/16-deep-code-review/16-REVIEW.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "Config writes in save_settings use atomic write-then-rename pattern (tempfile + fsync + os.replace)"
    - "Page parameter in partial_history_results uses safe_int with bounds instead of bare int()"
    - "Validation except clause in save_settings catches pydantic.ValidationError specifically, not bare Exception"
    - "16-REVIEW.md has resolution status (Fixed, Won't Fix, or Deferred) for every warning and medium issue"
  artifacts:
    - path: "fetcharr/web/routes.py"
      provides: "Atomic config write, safe page parsing, narrow validation catch"
      contains: "os.replace"
    - path: ".planning/phases/16-deep-code-review/16-REVIEW.md"
      provides: "Resolution status for all review findings"
      contains: "Fixed"
  key_links:
    - from: "fetcharr/web/routes.py"
      to: "fetcharr/web/validation.py"
      via: "safe_int import"
      pattern: "safe_int.*page"
    - from: "fetcharr/web/routes.py"
      to: "pydantic.ValidationError"
      via: "narrow except clause"
      pattern: "except pydantic\\.ValidationError"
---

<objective>
Fix 3 warning-level code review issues in routes.py: W2 (non-atomic config write), W3 (unvalidated page parameter), W8 (bare except Exception in validation). Then update 16-REVIEW.md with resolution status for all warning and medium issues.

Purpose: Bring routes.py into compliance with CLAUDE.md conventions and produce a living review document tracking all findings.
Output: Patched routes.py and updated review report.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-deep-code-review/16-REVIEW.md
@.planning/phases/16-deep-code-review/16-CONTEXT.md
@.planning/phases/16-deep-code-review/16-01-SUMMARY.md
@fetcharr/web/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix W2 (atomic config write), W3 (page validation), W8 (narrow except)</name>
  <files>fetcharr/web/routes.py</files>
  <action>
**W2 -- Non-atomic config write (routes.py:235):**
Replace the bare `config_path.write_text(tomli_w.dumps(new_config))` with an atomic write-then-rename pattern matching the pattern used in `state.py`. Add `import tempfile` to the imports at the top of the file.

Replace:
```python
config_path.write_text(tomli_w.dumps(new_config))
os.chmod(config_path, 0o600)
```
with:
```python
content = tomli_w.dumps(new_config)
with tempfile.NamedTemporaryFile(mode="w", dir=config_path.parent, suffix=".tmp", delete=False) as tmp:
    tmp.write(content)
    tmp.flush()
    os.fsync(tmp.fileno())
os.replace(tmp.name, str(config_path))
os.chmod(config_path, 0o600)
```

This ensures a crash mid-write cannot corrupt the config file -- the rename is atomic on POSIX systems.

**W3 -- Unvalidated page parameter (routes.py:162):**
In `partial_history_results`, replace:
```python
page = int(params.get("page", "1"))
```
with:
```python
page = safe_int(params.get("page"), default=1, minimum=1, maximum=10_000)
```
The `safe_int` helper is already imported. This prevents a 500 error on non-numeric `?page=abc` input.

**W8 -- Bare except Exception in save_settings validation (routes.py:228-232):**
Add `import pydantic` to the imports. Then narrow the except clause from:
```python
except Exception:
    logger.warning("Invalid settings rejected -- config file unchanged")
```
to:
```python
except pydantic.ValidationError as exc:
    logger.warning("Invalid settings rejected: {exc}", exc=exc)
```
This surfaces the actual validation error details in the log while no longer swallowing unrelated exceptions.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_web.py -x -q</automated>
    <manual>Check routes.py for: tempfile import, os.replace in save_settings, safe_int for page, pydantic.ValidationError in except</manual>
  </verify>
  <done>
    - save_settings uses atomic tempfile + fsync + os.replace for config writes
    - partial_history_results uses safe_int for page param (no 500 on bad input)
    - Validation catch is narrowed to pydantic.ValidationError with error detail in log
    - All existing web tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update 16-REVIEW.md with resolution status for all findings</name>
  <files>.planning/phases/16-deep-code-review/16-REVIEW.md</files>
  <action>
Update 16-REVIEW.md to mark each issue with its resolution status. Add a resolution line after each issue heading with format: `**Resolution:** Fixed | Won't Fix | Deferred`.

**Warning issues:**
- W1: `**Resolution:** Fixed -- hx-vals switched to double-quoted tojson filter pattern`
- W2: `**Resolution:** Fixed -- atomic write-then-rename via tempfile + fsync + os.replace`
- W3: `**Resolution:** Fixed -- bare int() replaced with safe_int()`
- W4: `**Resolution:** Fixed -- all cursors wrapped in async with for deterministic cleanup`
- W5: `**Resolution:** Fixed -- per_page/page guards added at function top`
- W6: `**Resolution:** Won't Fix -- broad except Exception is intentional safety net in Sonarr client (per user decision)`
- W7: `**Resolution:** Fixed -- added Azure/Alibaba metadata hosts, is_loopback check for IPv6/IPv4 loopback and 0.0.0.0`
- W8: `**Resolution:** Fixed -- narrowed to pydantic.ValidationError with error detail logging`

**Medium issues (M1-M8):**
- Each gets: `**Resolution:** Deferred -- backlog for next milestone`

Add a summary section at the top of the file (after the stats table) like:
```
## Resolution Summary

| Level | Total | Fixed | Won't Fix | Deferred |
|-------|-------|-------|-----------|----------|
| Warning (80-94) | 8 | 7 | 1 | 0 |
| Medium (70-79) | 8 | 0 | 0 | 8 |
| Filtered (<70) | 14 | 0 | 0 | 14 |
```
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && grep -c "Resolution:" .planning/phases/16-deep-code-review/16-REVIEW.md</automated>
    <manual>Verify each warning issue has a Resolution line and the summary table is present</manual>
  </verify>
  <done>
    - All 8 warning issues have Resolution status (7 Fixed, 1 Won't Fix)
    - All 8 medium issues have Resolution status (8 Deferred)
    - Filtered issues noted as Deferred
    - Resolution summary table added at top of review document
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/julianamacbook/fetcharr && uv run pytest tests/ -x -q
cd /Users/julianamacbook/fetcharr && uv run ruff check fetcharr/ tests/
```
All tests pass. No ruff violations introduced. 16-REVIEW.md has 16+ Resolution lines.
</verification>

<success_criteria>
- W2: save_settings uses tempfile + os.fsync + os.replace for atomic config write
- W3: page param parsed via safe_int with default=1, minimum=1, maximum=10_000
- W8: except clause catches pydantic.ValidationError specifically, logs the error detail
- 16-REVIEW.md has resolution status for all 8 warning issues and all 8 medium issues
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/16-deep-code-review/16-02-SUMMARY.md`
</output>
