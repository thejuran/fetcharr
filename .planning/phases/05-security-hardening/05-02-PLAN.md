---
phase: 05-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - fetcharr/web/validation.py
  - fetcharr/web/routes.py
  - fetcharr/config.py
  - tests/test_validation.py
autonomous: true
requirements:
  - SECR-03
  - SECR-04
  - SECR-06

must_haves:
  truths:
    - "Submitting a non-http/https URL in settings form is rejected with a user-visible error"
    - "Submitting a cloud metadata endpoint (169.254.169.254) as URL is rejected"
    - "Submitting non-numeric text for integer form fields does not crash -- defaults are used"
    - "Integer form fields are clamped to safe bounds (interval 1-1440, counts 1-100)"
    - "log_level only accepts debug/info/warning/error -- anything else defaults to info"
    - "Config TOML file is written with 0o600 permissions after every save"
    - "Default config generation also sets 0o600 permissions"
  artifacts:
    - path: "fetcharr/web/validation.py"
      provides: "URL validation, integer clamping, log level allowlist helpers"
      contains: "validate_arr_url"
    - path: "tests/test_validation.py"
      provides: "Tests for all validation helpers"
      min_lines: 40
  key_links:
    - from: "fetcharr/web/routes.py"
      to: "fetcharr/web/validation.py"
      via: "import and call in save_settings"
      pattern: "from fetcharr\\.web\\.validation import"
    - from: "fetcharr/config.py"
      to: "os.chmod"
      via: "permission setting after config write"
      pattern: "os\\.chmod.*0o600"
---

<objective>
Harden the settings save path: add URL scheme + SSRF validation, integer clamping with safe bounds, log level allowlisting, and restrictive file permissions on config writes.

Purpose: Prevent SSRF via user-supplied URLs, eliminate crash-on-bad-input for form fields, and protect config files containing API keys from other system users.
Output: Validation helpers module, hardened save_settings route, secure config writes with 0o600 permissions
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-security-hardening/05-RESEARCH.md
@fetcharr/web/routes.py
@fetcharr/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation helpers with tests</name>
  <files>
    fetcharr/web/validation.py
    tests/test_validation.py
  </files>
  <action>
Create `fetcharr/web/validation.py` with three helper functions:

**1. `validate_arr_url(url: str) -> tuple[bool, str]`**
- Empty/whitespace-only URL returns `(True, "")` -- app is disabled, empty is valid
- Parse with `urllib.parse.urlparse`. Reject if `scheme` not in `{"http", "https"}` -- return `(False, "URL scheme must be http or https")`
- Reject if `hostname` is None -- return `(False, "URL has no hostname")`
- Check against `BLOCKED_HOSTS = {"169.254.169.254", "metadata.google.internal"}` -- return `(False, "Blocked hostname")`
- Check if hostname is an IP literal using `ipaddress.ip_address(hostname)`. If it's `is_link_local` (covers 169.254.0.0/16), return `(False, "Link-local address blocked")`. Catch `ValueError` for non-IP hostnames (like "radarr") and allow them.
- Do NOT block private ranges (10.x, 172.x, 192.168.x) -- *arr apps run on local network by design (see Research Pitfall 1).
- Return `(True, "")` if all checks pass.

**2. `safe_int(value: str | None, default: int, minimum: int, maximum: int) -> int`**
- If value is None or empty string, return default
- Try `int(value)`. On `ValueError` or `TypeError`, return default.
- Clamp result: `max(minimum, min(maximum, n))`

**3. `ALLOWED_LOG_LEVELS = {"debug", "info", "warning", "error"}`**
   `def safe_log_level(value: str | None) -> str`
- Strip and lowercase the input. If it's in `ALLOWED_LOG_LEVELS`, return it. Otherwise return `"info"`.

Create `tests/test_validation.py` with tests:

For `validate_arr_url`:
1. Valid http URL -> `(True, "")`
2. Valid https URL -> `(True, "")`
3. Empty string -> `(True, "")` (disabled app)
4. `ftp://` scheme -> `(False, ...)` rejected
5. `file:///etc/passwd` -> `(False, ...)` rejected
6. `http://169.254.169.254/latest/meta-data` -> `(False, ...)` SSRF blocked
7. `http://metadata.google.internal` -> `(False, ...)` SSRF blocked
8. `http://169.254.42.42` -> `(False, ...)` link-local blocked
9. `http://192.168.1.100:7878` -> `(True, "")` private IP allowed (not blocked)
10. `http://10.0.0.5:7878` -> `(True, "")` private IP allowed
11. `http://radarr:7878` -> `(True, "")` hostname allowed

For `safe_int`:
1. Valid "30" with bounds 1-1440 -> 30
2. None -> returns default
3. Empty string -> returns default
4. "abc" -> returns default
5. "0" with min=1 -> clamped to 1
6. "9999" with max=1440 -> clamped to 1440
7. "-5" with min=1 -> clamped to 1

For `safe_log_level`:
1. "debug" -> "debug"
2. "INFO" -> "info" (case-insensitive)
3. " warning " -> "warning" (strips whitespace)
4. "critical" -> "info" (not in allowlist)
5. "" -> "info"
6. None -> "info"
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && python -m pytest tests/test_validation.py -x -v</automated>
  </verify>
  <done>Three validation helpers created with comprehensive tests. URL validation blocks non-http schemes and metadata endpoints. safe_int handles garbage input gracefully. safe_log_level enforces allowlist.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation into save_settings and secure config writes</name>
  <files>
    fetcharr/web/routes.py
    fetcharr/config.py
  </files>
  <action>
**Update `fetcharr/web/routes.py` save_settings function:**

Add import at top of file:
```python
from fetcharr.web.validation import validate_arr_url, safe_int, safe_log_level
```

In `save_settings`, replace the current integer parsing with `safe_int`:
- `"search_interval": int(form.get(..., 30))` becomes `"search_interval": safe_int(form.get(f"{name}_search_interval"), 30, 1, 1440)`
- `"search_missing_count": int(form.get(..., 5))` becomes `"search_missing_count": safe_int(form.get(f"{name}_search_missing_count"), 5, 1, 100)`
- `"search_cutoff_count": int(form.get(..., 5))` becomes `"search_cutoff_count": safe_int(form.get(f"{name}_search_cutoff_count"), 5, 1, 100)`

Replace `"log_level": form.get("log_level", "info")` with `"log_level": safe_log_level(form.get("log_level"))`.

Add URL validation for each app's URL. After building the `new_config[name]` dict, validate the URL:
```python
url = form.get(f"{name}_url", "").strip()
valid, err = validate_arr_url(url)
if not valid:
    logger.warning("{name}: URL rejected -- {err}", name=name.title(), err=err)
    return RedirectResponse(url="/settings", status_code=303)
new_config[name]["url"] = url
```
Move the URL assignment out of the dict literal and into the validated path. The redirect back to /settings on invalid URL is acceptable UX for a security hardening pass -- a flash message system would be a future enhancement.

Add `import os` at top of file. After the `config_path.write_text(tomli_w.dumps(new_config))` line, add:
```python
os.chmod(config_path, 0o600)
```

**Update `fetcharr/config.py` generate_default_config:**

Add `import os` at top of file. After `config_path.write_text(DEFAULT_CONFIG)`, add:
```python
os.chmod(config_path, 0o600)
```

This ensures both first-run default config and web UI saves produce files with restrictive permissions.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && python -m pytest tests/ -x -v</automated>
  </verify>
  <done>save_settings uses safe_int (no more ValueError crashes on bad input), safe_log_level (allowlist enforced), validate_arr_url (SSRF blocked), and os.chmod 0o600 after every config write. generate_default_config also sets 0o600. All existing tests still pass.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_validation.py -x -v` -- all validation helper tests pass
2. `python -m pytest tests/ -x -v` -- all project tests pass (no regressions)
3. `grep -c "safe_int" fetcharr/web/routes.py` returns 3 (three integer fields clamped)
4. `grep -c "validate_arr_url" fetcharr/web/routes.py` returns at least 1 (URL validation active)
5. `grep -c "0o600" fetcharr/web/routes.py fetcharr/config.py` returns 2 (both write paths secured)
6. `grep -c "safe_log_level" fetcharr/web/routes.py` returns 1 (log level allowlist active)
</verification>

<success_criteria>
- URL validation rejects non-http/https schemes and cloud metadata endpoints
- Integer form fields never crash on bad input, always clamped to safe bounds
- log_level rejects unknown values, defaults to "info"
- Config file written with 0o600 permissions in both save_settings and generate_default_config
- All existing tests continue to pass (no regressions)
- Validation helpers have comprehensive test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/05-security-hardening/05-02-SUMMARY.md`
</output>
