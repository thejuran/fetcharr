---
phase: 14-dashboard-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fetcharr/templates/partials/app_card.html
  - fetcharr/db.py
  - fetcharr/search/engine.py
  - fetcharr/templates/partials/search_log.html
  - tests/test_db.py
  - tests/test_search.py
autonomous: true
requirements: [WEBU-09, WEBU-11]

must_haves:
  truths:
    - "Dashboard position labels display 'X of Y' format (e.g., '3 of 47') for both missing and cutoff queues"
    - "Search log entries display outcome (searched/failed) and detail text alongside item name and timestamp"
    - "Existing search history entries without outcome/detail still render correctly (backward compatible)"
  artifacts:
    - path: "fetcharr/templates/partials/app_card.html"
      provides: "X of Y position format"
      contains: "of {{ app.missing_count"
    - path: "fetcharr/db.py"
      provides: "Search history with outcome/detail columns"
      contains: "outcome TEXT"
    - path: "fetcharr/search/engine.py"
      provides: "Outcome/detail passed to insert_search_entry"
      contains: "outcome="
    - path: "fetcharr/templates/partials/search_log.html"
      provides: "Outcome display in search log entries"
      contains: "entry.outcome"
  key_links:
    - from: "fetcharr/search/engine.py"
      to: "fetcharr/db.py"
      via: "insert_search_entry with outcome/detail params"
      pattern: "insert_search_entry.*outcome="
    - from: "fetcharr/templates/partials/search_log.html"
      to: "fetcharr/db.py"
      via: "get_recent_searches returns outcome/detail fields"
      pattern: "entry\\.outcome"
---

<objective>
Enhance dashboard position labels to show "X of Y" format and add outcome/detail information to search log entries.

Purpose: Users currently see bare cursor numbers (e.g., "Position 3") which are meaningless without knowing the total. Search log entries show only item name and timestamp with no indication of whether the search succeeded or failed. This plan addresses both gaps.

Output: Updated app card template with "X of Y" positions, search_history table with outcome/detail columns, engine passing outcome data on insert, and search log template showing outcomes.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@fetcharr/templates/partials/app_card.html
@fetcharr/templates/partials/search_log.html
@fetcharr/db.py
@fetcharr/search/engine.py
@fetcharr/web/routes.py
@tests/test_db.py
@tests/test_search.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "X of Y" position labels and search detail columns</name>
  <files>
    fetcharr/templates/partials/app_card.html
    fetcharr/db.py
    fetcharr/search/engine.py
    fetcharr/templates/partials/search_log.html
    fetcharr/web/routes.py
  </files>
  <action>
**WEBU-09: Position labels**

In `fetcharr/templates/partials/app_card.html`, update the two position display lines:

Change the Missing position line from:
```html
<p class="text-xs text-fetcharr-muted">Position {{ app.missing_cursor }}</p>
```
to:
```html
<p class="text-xs text-fetcharr-muted">{{ app.missing_cursor }} of {{ app.missing_count if app.missing_count is not none else '?' }}</p>
```

Apply the same pattern for the Cutoff position line, using `app.cutoff_cursor` and `app.cutoff_count`.

The data is already available -- `_build_app_context` in routes.py already passes `missing_count`, `cutoff_count`, `missing_cursor`, and `cutoff_cursor` from app state. No backend changes needed for WEBU-09.

**WEBU-11: Search detail/outcome in database**

In `fetcharr/db.py`:

1. Add a migration function `_migrate_add_outcome_columns(db)` that runs `ALTER TABLE search_history ADD COLUMN outcome TEXT DEFAULT NULL` and `ALTER TABLE search_history ADD COLUMN detail TEXT DEFAULT NULL`. Wrap each ALTER in try/except to handle "duplicate column" errors (table may already have the columns). Call this at the end of `init_db` after CREATE TABLE/INDEX.

2. Update `insert_search_entry` signature to accept two new optional params: `outcome: str = "searched"` and `detail: str = ""`. Include these in the INSERT statement.

3. Update `get_recent_searches` to SELECT and return `outcome` and `detail` in the result dicts (with fallback to empty string for rows that predate the migration).

**WEBU-11: Engine passes outcome/detail**

In `fetcharr/search/engine.py`:

For both `run_radarr_cycle` and `run_sonarr_cycle`, update the `insert_search_entry` calls:

- Success case: pass `outcome="searched"` and `detail="search triggered"` (this is the default, so just adding explicitly for clarity is fine -- or rely on the default).
- Failure case (in the except block): call `insert_search_entry` with `outcome="failed"` and `detail=str(exc)[:200]` (truncate to avoid storing huge error messages). Currently the failure case only logs but does NOT insert into the search history. Add the insert call in the except block.

Update all 4 places in engine.py (missing+cutoff for both Radarr and Sonarr):
- Success: `await insert_search_entry(db_path, "App", "queue_type", name, outcome="searched", detail="search triggered")`
- Failure: `await insert_search_entry(db_path, "App", "queue_type", name, outcome="failed", detail=str(exc)[:200])`

**WEBU-11: Search log template**

In `fetcharr/templates/partials/search_log.html`, update each search log entry row to display the outcome. Add an outcome badge after the queue_type span:

```html
<span class="text-xs px-1.5 py-0.5 rounded
       {% if entry.outcome == 'failed' %}bg-red-500/20 text-red-400
       {% else %}bg-fetcharr-green/20 text-fetcharr-green{% endif %}">
    {{ entry.outcome or 'searched' }}
</span>
```

If `entry.detail` is non-empty, show it as a title attribute on the item name span so users can hover to see the detail:
```html
<span class="text-sm flex-1 truncate" {% if entry.detail %}title="{{ entry.detail }}"{% endif %}>{{ entry.name }}</span>
```
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_db.py tests/test_web.py -x -q</automated>
    <manual>Visually confirm app_card.html has "X of Y" format and search_log.html has outcome badge</manual>
  </verify>
  <done>
    - App card position labels show "X of Y" format for both missing and cutoff queues
    - search_history table has outcome and detail columns
    - insert_search_entry accepts and stores outcome/detail
    - get_recent_searches returns outcome/detail fields
    - Engine passes outcome="searched" on success, outcome="failed" with detail on failure
    - Search log template displays outcome badge (green for searched, red for failed)
    - Hovering item name shows detail text when available
    - Existing entries without outcome/detail render with "searched" default
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for outcome/detail search history and position labels</name>
  <files>
    tests/test_db.py
    tests/test_search.py
    tests/test_web.py
  </files>
  <action>
**tests/test_db.py -- Add outcome/detail tests:**

1. `test_insert_with_outcome_and_detail`: Insert an entry with `outcome="failed"` and `detail="Connection refused"`. Retrieve it and assert both fields are returned correctly.

2. `test_insert_default_outcome`: Insert an entry without specifying outcome/detail (relying on defaults). Retrieve and assert `outcome == "searched"` and `detail == ""`.

3. `test_migration_preserves_existing_rows`: Insert an entry (after init_db), then call init_db again (which triggers migration). Verify the existing entry still has `outcome` (should be NULL/None from the migration, returned as empty string or None). This tests backward compatibility.

**tests/test_search.py -- Add outcome logging tests:**

1. `test_radarr_cycle_logs_failed_search_to_db`: Set up a Radarr cycle where `client.search_movies` raises an exception on the first movie. After the cycle, query the DB and verify an entry exists with `outcome="failed"` and a non-empty `detail`.

2. `test_sonarr_cycle_logs_failed_search_to_db`: Same pattern for Sonarr -- make `client.search_season` raise an exception, verify `outcome="failed"` entry in DB.

**tests/test_web.py -- Add position label test:**

1. `test_dashboard_shows_position_x_of_y`: Assert the dashboard response contains "3 of 42" (using the mock state where radarr missing_cursor=3, missing_count=42). This confirms WEBU-09 end-to-end.

2. `test_search_log_shows_outcome_badge`: Insert a search entry with `outcome="failed"`, then GET `/partials/search-log` and assert "failed" appears in the response text.

Follow existing test patterns: use `tmp_path` for db_path, `await init_db(db_path)` before each test, AsyncMock for clients, existing conftest helpers.
  </action>
  <verify>
    <automated>cd /Users/julianamacbook/fetcharr && uv run pytest tests/test_db.py tests/test_search.py tests/test_web.py -x -q</automated>
  </verify>
  <done>
    - At least 3 new tests in test_db.py covering outcome/detail insert, default, and migration compat
    - At least 2 new tests in test_search.py covering failed search DB entries
    - At least 2 new tests in test_web.py covering position label format and outcome badge
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/ -x -q` -- All tests pass (existing + new)
2. `uv run ruff check fetcharr/ tests/` -- No lint violations
3. App card template contains "of {{ app.missing_count" and "of {{ app.cutoff_count" patterns
4. Search log template contains "entry.outcome" display
5. Engine has `outcome=` in insert_search_entry calls (both success and failure paths)
</verification>

<success_criteria>
- Dashboard position labels show "X of Y" format for missing and cutoff in both Radarr and Sonarr cards
- Search log entries display a colored outcome badge (green=searched, red=failed)
- Failed searches are recorded in the database with detail text
- Hover on item name shows detail tooltip when available
- All existing tests continue to pass
- At least 7 new tests added covering the changes
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-observability/14-01-SUMMARY.md`
</output>
