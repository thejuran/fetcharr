<div id="history-results">

  {# --- Filter bar --- #}
  <div class="bg-fetcharr-card rounded-lg border border-fetcharr-border p-4 mb-4">
    <div class="flex flex-wrap items-center gap-4">

      {# App filter #}
      <div class="flex items-center gap-2">
        <span class="text-xs text-fetcharr-muted">App:</span>
        {% set apps_csv = active_apps | join(',') %}
        {% for app_val in ['Radarr', 'Sonarr'] %}
          {% if app_val in active_apps %}
            {# Currently active -- click removes it #}
            {% set new_apps = active_apps | reject('equalto', app_val) | list | join(',') %}
          {% else %}
            {# Currently inactive -- click adds it #}
            {% set new_apps = (active_apps + [app_val]) | join(',') %}
          {% endif %}
          <a hx-get="/partials/history-results?page=1&app={{ new_apps }}&queue={{ active_queues | join(',') }}&outcome={{ active_outcomes | join(',') }}&search={{ search_text }}"
             hx-target="#history-results"
             hx-swap="outerHTML"
             class="cursor-pointer text-xs font-medium px-2.5 py-1 rounded-full
                    {% if app_val in active_apps %}
                      {% if app_val == 'Radarr' %}bg-orange-500/20 text-orange-400{% else %}bg-blue-500/20 text-blue-400{% endif %}
                    {% else %}
                      bg-fetcharr-card text-fetcharr-muted border border-fetcharr-border hover:text-white
                    {% endif %}">
            {{ app_val }}
          </a>
        {% endfor %}
      </div>

      {# Queue type filter #}
      <div class="flex items-center gap-2">
        <span class="text-xs text-fetcharr-muted">Queue:</span>
        {% for q_val in ['missing', 'cutoff'] %}
          {% if q_val in active_queues %}
            {% set new_queues = active_queues | reject('equalto', q_val) | list | join(',') %}
          {% else %}
            {% set new_queues = (active_queues + [q_val]) | join(',') %}
          {% endif %}
          <a hx-get="/partials/history-results?page=1&app={{ active_apps | join(',') }}&queue={{ new_queues }}&outcome={{ active_outcomes | join(',') }}&search={{ search_text }}"
             hx-target="#history-results"
             hx-swap="outerHTML"
             class="cursor-pointer text-xs font-medium px-2.5 py-1 rounded-full
                    {% if q_val in active_queues %}
                      bg-fetcharr-green/20 text-fetcharr-green
                    {% else %}
                      bg-fetcharr-card text-fetcharr-muted border border-fetcharr-border hover:text-white
                    {% endif %}">
            {{ q_val }}
          </a>
        {% endfor %}
      </div>

      {# Outcome filter #}
      <div class="flex items-center gap-2">
        <span class="text-xs text-fetcharr-muted">Outcome:</span>
        {% for o_val in ['searched', 'failed'] %}
          {% if o_val in active_outcomes %}
            {% set new_outcomes = active_outcomes | reject('equalto', o_val) | list | join(',') %}
          {% else %}
            {% set new_outcomes = (active_outcomes + [o_val]) | join(',') %}
          {% endif %}
          <a hx-get="/partials/history-results?page=1&app={{ active_apps | join(',') }}&queue={{ active_queues | join(',') }}&outcome={{ new_outcomes }}&search={{ search_text }}"
             hx-target="#history-results"
             hx-swap="outerHTML"
             class="cursor-pointer text-xs font-medium px-2.5 py-1 rounded-full
                    {% if o_val in active_outcomes %}
                      {% if o_val == 'failed' %}bg-red-500/20 text-red-400{% else %}bg-fetcharr-green/20 text-fetcharr-green{% endif %}
                    {% else %}
                      bg-fetcharr-card text-fetcharr-muted border border-fetcharr-border hover:text-white
                    {% endif %}">
            {{ o_val }}
          </a>
        {% endfor %}
      </div>

      {# Text search #}
      <div class="flex-1 min-w-[180px]">
        <input type="search"
               name="search"
               value="{{ search_text }}"
               placeholder="Search by title..."
               hx-get="/partials/history-results"
               hx-trigger="keyup changed delay:300ms"
               hx-target="#history-results"
               hx-swap="outerHTML"
               hx-vals="{{ {'app': active_apps | join(','), 'queue': active_queues | join(','), 'outcome': active_outcomes | join(','), 'page': '1'} | tojson }}"
               class="w-full bg-fetcharr-bg border border-fetcharr-border text-fetcharr-text rounded px-3 py-1.5 text-sm placeholder-fetcharr-muted focus:outline-none focus:border-fetcharr-green">
      </div>
    </div>
  </div>

  {# --- Results section --- #}
  {% if result.entries %}
    {% set start = (result.page - 1) * result.per_page + 1 %}
    {% set end = [result.page * result.per_page, result.total] | min %}
    <p class="text-xs text-fetcharr-muted mb-2">Showing {{ start }}-{{ end }} of {{ result.total }} results</p>

    <div class="bg-fetcharr-card rounded-lg border border-fetcharr-border p-5">
      <div class="space-y-0">
        {% for entry in result.entries %}
        <div class="flex items-center gap-3 py-1.5 {% if not loop.last %}border-b border-fetcharr-border/50{% endif %}">
          <span class="text-xs font-medium px-2 py-0.5 rounded
                 {% if entry.app == 'Radarr' %}bg-orange-500/20 text-orange-400
                 {% else %}bg-blue-500/20 text-blue-400{% endif %}">
            {{ entry.app }}
          </span>
          <span class="text-sm flex-1 truncate" {% if entry.detail %}title="{{ entry.detail }}"{% endif %}>{{ entry.name }}</span>
          <span class="text-xs text-fetcharr-muted">{{ entry.queue_type }}</span>
          <span class="text-xs px-1.5 py-0.5 rounded
                 {% if entry.outcome == 'failed' %}bg-red-500/20 text-red-400
                 {% else %}bg-fetcharr-green/20 text-fetcharr-green{% endif %}">
            {{ entry.outcome or 'searched' }}
          </span>
          <span class="text-xs text-fetcharr-muted">{{ entry.timestamp[:19] | replace('T', ' ') }}</span>
        </div>
        {% endfor %}
      </div>
    </div>

  {% else %}
    <p class="text-fetcharr-muted text-sm py-8 text-center">No search history yet. Searches will appear here after your first scheduled run.</p>
  {% endif %}

  {# --- Pagination --- #}
  {% if result.total_pages > 1 %}
    {% set base_qs = "app=" ~ active_apps | join(',') ~ "&queue=" ~ active_queues | join(',') ~ "&outcome=" ~ active_outcomes | join(',') ~ "&search=" ~ search_text %}
    <div class="flex items-center justify-center gap-2 mt-4">

      {# Previous #}
      {% if result.page > 1 %}
        <a hx-get="/partials/history-results?page={{ result.page - 1 }}&{{ base_qs }}"
           hx-target="#history-results"
           hx-swap="outerHTML"
           class="cursor-pointer text-xs px-3 py-1.5 rounded bg-fetcharr-card text-fetcharr-muted border border-fetcharr-border hover:text-white">
          Previous
        </a>
      {% else %}
        <span class="text-xs px-3 py-1.5 rounded bg-fetcharr-card text-fetcharr-muted/40 border border-fetcharr-border cursor-not-allowed">
          Previous
        </span>
      {% endif %}

      {# Page numbers with ellipsis for large ranges #}
      {% set window = 2 %}
      {% for p in range(1, result.total_pages + 1) %}
        {% if p == 1 or p == result.total_pages or (p >= result.page - window and p <= result.page + window) %}
          {% if p == result.page %}
            <span class="text-xs px-3 py-1.5 rounded bg-fetcharr-green text-white font-medium">{{ p }}</span>
          {% else %}
            <a hx-get="/partials/history-results?page={{ p }}&{{ base_qs }}"
               hx-target="#history-results"
               hx-swap="outerHTML"
               class="cursor-pointer text-xs px-3 py-1.5 rounded bg-fetcharr-card text-fetcharr-muted border border-fetcharr-border hover:text-white">
              {{ p }}
            </a>
          {% endif %}
        {% elif p == 2 or p == result.total_pages - 1 %}
          <span class="text-xs text-fetcharr-muted">...</span>
        {% endif %}
      {% endfor %}

      {# Next #}
      {% if result.page < result.total_pages %}
        <a hx-get="/partials/history-results?page={{ result.page + 1 }}&{{ base_qs }}"
           hx-target="#history-results"
           hx-swap="outerHTML"
           class="cursor-pointer text-xs px-3 py-1.5 rounded bg-fetcharr-card text-fetcharr-muted border border-fetcharr-border hover:text-white">
          Next
        </a>
      {% else %}
        <span class="text-xs px-3 py-1.5 rounded bg-fetcharr-card text-fetcharr-muted/40 border border-fetcharr-border cursor-not-allowed">
          Next
        </span>
      {% endif %}

    </div>
  {% endif %}

</div>
